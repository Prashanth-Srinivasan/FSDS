image : python:3.13

stages:
  - lint
  - test
  - build
  - verify
  - docker-build
  - docker-push

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  PYTHON_VERSION: "3.13"

before_script:
  - python3 --version
  - pip install --upgrade pip setuptools wheel
  - pip install isort black flake8 pytest

# Lint: isort, black, flake8
lint:
  stage: lint
  script:
    - echo "Running isort..."
    - isort . --check-only

    - echo "Running black..."
    - black . --check

    - echo "Running flake8..."
    - flake8 .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false


# Unit Tests
test:
  stage: test
  script:
    - export PYTHONPATH="$CI_PROJECT_DIR"
    - pip install -e .
    - pytest --maxfail=1 --disable-warnings -q -m "not local_only"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - .pytest_cache/
    expire_in: 7 days

# Build wheel package
build:
  stage: build
  script:
    - pip install build
    - python -m build --wheel
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - dist/*.whl
    expire_in: 7 days

# Verify: install the generated wheel and import it
verify-build:
  stage: verify
  needs: ["build"]
  script:
    - echo "Wheel files downloaded:"
    - ls -R dist/

    - pip install dist/*.whl

    - echo "Running workflow script..."
    - |
        python << 'EOF'
        import datetime

        def log(msg):
            print(f"{datetime.datetime.now().isoformat()} - {msg}")

        log("Testing import of package...")
        try:
            import housing_price
            log("Import successful!")
        except Exception as e:
            log(f"Import failed: {e}")
            raise

        log("Workflow completed!")
        EOF
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Docker build
docker-build:
  stage: docker-build
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script: []
  script:
    - docker build -t $ACR_LOGIN_SERVER/$DOCKER_IMAGE_NAME:latest .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Docker push to ACR
docker-push:
  stage: docker-push
  image: docker:24
  services:
    - docker:24-dind
  variables:
    DOCKER_TLS_CERTDIR: ""
  before_script: []
  script:
    - echo "$ACR_PASSWORD" | docker login $ACR_LOGIN_SERVER -u "$ACR_USERNAME" --password-stdin
    - docker push $ACR_LOGIN_SERVER/$DOCKER_IMAGE_NAME:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"