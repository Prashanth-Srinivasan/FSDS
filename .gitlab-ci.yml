image: python:3.13

stages:
  - lint
  - test
  - build
  - verify
  - monitor
  - kaniko-build-and-push

# Global variables
variables:
  PYTHON_VERSION: "3.13"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_TLS_CERTDIR: ""

cache:
  paths:
    - .cache/pip

before_script:
  - python --version
  - pip install --upgrade pip setuptools wheel
  - pip install isort black flake8 pytest

# ------------------------
# LINT
# ------------------------
lint:
  stage: lint
  script:
    - echo "Running isort..."
    - isort . --check-only
    - echo "Running black..."
    - black . --check
    - echo "Running flake8..."
    - flake8 .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  allow_failure: false

# ------------------------
# TEST
# ------------------------
test:
  stage: test
  script:
    - export PYTHONPATH="$CI_PROJECT_DIR"
    - pip install -e .
    - pytest --maxfail=1 --disable-warnings -q -m "not local_only"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - .pytest_cache/
    expire_in: 7 days

# ------------------------
# BUILD (wheel)
# ------------------------
build:
  stage: build
  script:
    - pip install build
    - python -m build --wheel
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  artifacts:
    paths:
      - dist/*.whl
    expire_in: 7 days

# ------------------------
# VERIFY BUILD
# ------------------------
verify-build:
  stage: verify
  needs: ["build"]
  script:
    - echo "Available wheel files:"
    - ls -l dist/
    - pip install dist/*.whl
    - |
      python << 'EOF'
      import datetime

      def log(msg):
          print(f"{datetime.datetime.now().isoformat()} - {msg}")

      log("Testing package import...")
      try:
          import housing_price
          log("Import successful!")
      except Exception as e:
          log(f"Import failed: {e}")
          raise

      log("Verification completed!")
      EOF
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ------------------------
# DATA DRIFT MONITORING
# ------------------------
drift-monitoring:
  stage: monitor
  image: python:3.10   # Evidently is safest on 3.10
  needs: ["verify-build"]
  script:
    - python --version
    - pip install --upgrade pip
    - pip install evidently>=0.7.19 pandas scikit-learn
    - export PYTHONPATH="$CI_PROJECT_DIR/src"
    - python monitoring/drift_report.py
  artifacts:
    when: always
    paths:
      - reports/
    expire_in: 14 days
  allow_failure: false
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"


# ------------------------
# KANIKO BUILD & PUSH (ACR)
# ------------------------
kaniko-build-and-push:
  stage: kaniko-build-and-push
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]  # Override entrypoint to empty
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  before_script:
    - echo "{\"auths\":{\"$ACR_LOGIN_SERVER\":{\"auth\":\"$(printf "%s:%s" "$ACR_USERNAME" "$ACR_PASSWORD" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
  script:
    - /kaniko/executor
      --context=$CI_PROJECT_DIR
      --dockerfile=$CI_PROJECT_DIR/Dockerfile
      --destination=$ACR_LOGIN_SERVER/housing-price-api:$CI_COMMIT_SHORT_SHA
      --destination=$ACR_LOGIN_SERVER/housing-price-api:latest
      --cache=true